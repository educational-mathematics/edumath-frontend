<div class="container">
  <h1 class="welcome-title">Test de Estilos de Aprendizaje</h1>

  <div class="content">

    <!-- Paso 0: elegir rol -->
    @if (!answeredBy && !showResults) {
      <section class="card">
        <h2 class="card-title">¿Quién responderá el test?</h2>

        <div class="role-grid">
          <label class="role-option">
            <input type="radio" name="who" [(ngModel)]="selectedRole" value="alumno" />
            <span class="role-text">Soy el estudiante</span>
          </label>

          <label class="role-option">
            <input type="radio" name="who" [(ngModel)]="selectedRole" value="representante" />
            <span class="role-text">Soy el padre/maestro</span>
          </label>
        </div>

        <button class="btn" [disabled]="!selectedRole" (click)="confirmRole()">Continuar</button>
      </section>
    }

    <!-- Test activo -->
    @if (answeredBy && questions.length && !showResults) {
      <section class="card card-test">
        <div class="progress">
          <div class="progress-head">
            <span>Pregunta {{ index + 1 }} de {{ questions.length }}</span>
            <span class="progress-pct">
              {{ ((index + 1) * 100 / questions.length) | number:'1.0-0' }}%
            </span>
          </div>
          <div class="progress-track">
            <div class="progress-fill" [style.width.%]="(index + 1) * 100 / questions.length"></div>
          </div>
        </div>

        <h3 class="question-text">{{ current()?.text }}</h3>

        <div class="options">
          <label class="option-chip">
            <input type="radio"
                   [name]="'q'+(current()?.id ?? 0)"
                   [checked]="answers[current()?.id ?? 0]===0"
                   (change)="setAnswer(current()?.id!, 0)" />
            <span>0 = Nada</span>
          </label>

        <label class="option-chip">
            <input type="radio"
                   [name]="'q'+(current()?.id ?? 0)"
                   [checked]="answers[current()?.id ?? 0]===1"
                   (change)="setAnswer(current()?.id!, 1)" />
            <span>1 = Poco</span>
          </label>

          <label class="option-chip">
            <input type="radio"
                   [name]="'q'+(current()?.id ?? 0)"
                   [checked]="answers[current()?.id ?? 0]===2"
                   (change)="setAnswer(current()?.id!, 2)" />
            <span>2 = Mucho</span>
          </label>
        </div>

        <div class="nav">
          <button class="btn btn-secondary" (click)="prev()" [disabled]="index===0">Anterior</button>

          @if (index < questions.length - 1) {
            <button class="btn" (click)="next()" [disabled]="answers[current()?.id ?? 0]===undefined">Siguiente</button>
          } @else {
            <button class="btn primary" (click)="submit()" [disabled]="!canSubmit()">Finalizar test</button>
          }
        </div>
      </section>
    }

    @if (showStylePicker && !showResults) {
      <section class="card">
        <h2 class="card-title">Empate detectado</h2>
      
        <p class="mb-2">
          El puntaje quedó empatado entre: <strong>{{ tiedText }}</strong>.
          Elige tu preferencia para continuar:
        </p>
      
        <div class="style-grid">
          @for (s of tiedStyles; track s) {
            <label class="style-option">
              <input type="radio" name="pick" [(ngModel)]="selectedStyle" [value]="s" />
              <div>
                <strong>{{ styleLabel(s) }}</strong>
                <div class="desc">{{ styleDesc(s) }}</div>
              </div>
            </label>
          }
        </div>
      
        <div class="nav">
          <button class="btn primary" [disabled]="!selectedStyle" (click)="confirmPreferredStyle()">
            Confirmar estilo
          </button>
        </div>
      </section>
    }

    <!-- Resultados -->
    @if (showResults && resultStyle && resultScores) {
      <section class="card results-card">
        <div class="results-top">
          <div class="results-main">
            <div class="badge">¡Resultado!</div>
            <h2 class="result-title">
              Tu estilo de aprendizaje es: <br> <span class="result-highlight">¡ {{ resultStyle | uppercase }} !</span>
            </h2>
            <p class="result-sub">Basado en tus respuestas, este es el estilo predominante.</p>

            <div class="scores">
              <div class="score">
                <span>Visual</span>
                <strong>{{ resultScores.visual }}</strong>
              </div>
              <div class="score">
                <span>Auditivo</span>
                <strong>{{ resultScores.auditivo }}</strong>
              </div>
              <div class="score">
                <span>Kinestésico</span>
                <strong>{{ resultScores.kinestesico }}</strong>
              </div>
            </div>

            <div class="actions">
              <button class="btn primary" (click)="goHome()">Ir al inicio</button>
            </div>
          </div>

          <div class="kimi-wrap">
            <img src="assets/kimi.png" alt="Kimi" class="kimi" />
          </div>
        </div>

        <!-- canvas de confetti -->
        <canvas #confettiCanvas class="confetti-canvas"></canvas>
      </section>
    }
  </div>

  <h5 class="credits">
    Este test fue adaptado de Orientación Andújar, dales una mirada:
    <a class="link" href="https://www.orientacionandujar.es/2021/10/14/cuestionario-para-ninos-de-estilos-de-aprendizaje/" target="_blank">Aquí</a>
  </h5>
</div>
