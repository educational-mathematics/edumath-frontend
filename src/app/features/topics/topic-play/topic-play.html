@if (ready) {
  <div class="wrap">
    <div class="header">
      <h2>{{ title }}</h2>
      <div class="right">
        <span>Estilo: <b>{{ style }}</b></span>
        <span class="timer">{{ formatTime(elapsedSec) }}</span>
        <button class="exit" (click)="confirmExit()">Salir</button>
      </div>
    </div>

    @if (explanation) {
      <div class="explain">
        @if (style === 'auditivo' && ttsUrl) {
                <audio [src]="ttsUrl" controls #ttsAudio style="display: none;"></audio>
   
                <div class="custom-audio-control" (click)="toggleAudio()">
            <div class="audio-icon">
              @if (audioState === 'playing') {
                <span>‚è∏Ô∏è</span>           } @else {
                <span>üîä</span>           }
            </div>
            <div class="audio-status">
              @if (audioState === 'loading') {
                <span class="loading-text">Cargando audio...</span>
              } @else if (audioState === 'playing') {
                <span>Reproduciendo explicaci√≥n.</span>
              } @else {
                <span>Escuchar explicaci√≥n.</span>
              }
            </div>
          </div>
        }
        @if (style === 'visual' && explanationImageUrl) {
          <img [src]="explanationImageUrl.startsWith('/static') ? (apiBase + explanationImageUrl) : explanationImageUrl" alt="" class="expimg"/>
        }
        <p>{{ explanation }}</p>
      </div>
    }


    @if (item; as it) {
      <section>
        <div class="qhead">Ejercicio {{ currentIndex + 1 }} / 10</div>

        @if (it.type === 'multiple_choice') {
          <div class="mcq">
            @if (it.ttsUrl) {
              <audio [src]="it.ttsUrl" controls #questionAudio style="display: none;"></audio>
              <button class="play-button" (click)="toggleQuestionAudio()">
                <span>üîä Escuchar pregunta</span>
              </button>
            }
            <div class="q">{{ it.question }}</div>
            @if (it.imageUrl) {
              <img [src]="it.imageUrl?.startsWith('/static') ? (apiBase + it.imageUrl) : it.imageUrl" alt="" class="qimg" />
            }
            @for (c of it.choices; let i = $index; track i) {
              <label class="opt">
                <input
                  type="radio"
                  name="mcq"
                  [value]="i"
                  [(ngModel)]="mcqAnswer"
                  (change)="lastCorrect=null; feedback=null"
                />
                {{ c }}
              </label>
            }
            <div class="actions">
              <button class="primary" (click)="submit(mcqAnswer)">Responder</button>
            </div>
          </div>
        }
        
        @if (it.type === 'match_pairs') {
          <div class="pairs">
            <div class="q">{{ it.title || 'Empareja' }}</div>
            @for (L of lefts; let i = $index; track i) {
              <div class="row">
                <span class="left">{{ L }}</span>
                <select [(ngModel)]="pairAnswer[i]">
                  @for (R of rights; track R) {
                    <option [value]="R">{{ R }}</option>
                  }
                </select>
              </div>
            }
            <button class="primary" (click)="submitPairs()">Responder</button>
          </div>
        }

        @if (it.type === 'drag_to_bucket') {
          <div class="buckets">
            <div class="q">{{ it.title || 'Clasifica fracciones' }}</div>
          
            <table class="bucket-matrix">
              <thead>
                <tr>
                  <th>√çtem</th>
                  @for (b of it.buckets; track b) { <th>{{ b }}</th> }
                </tr>
              </thead>
              <tbody>
                @for (x of it.items; track x) {
                  <tr>
                    <td>{{ x }}</td>
                    @for (b of it.buckets; track b) {
                      <td class="center">
                        <input
                          type="radio"
                          [name]="'bucket-'+x"
                          [value]="b"
                          [checked]="bucketChoice[x] === b"
                          (change)="chooseBucket(x, b)"
                        />
                      </td>
                    }
                  </tr>
                }
              </tbody>
            </table>
            <button class="primary" (click)="submitBuckets()">Responder</button>
          </div>
        }

        @if (feedback !== null || lastCorrect !== null) {
          <div class="feedback">
            <span [class.ok]="lastCorrect === true" [class.err]="lastCorrect === false">
              {{ lastCorrect ? '¬°Correcto!' : 'Incorrecto' }}
            </span>
            @if (feedback && lastCorrect === false) {
              <div class="text">{{ feedback }}</div>
            }
            @if (lastCorrect === false) {
              <button class="secondary" (click)="retry()">Volver a intentar</button>
            }
          </div>
        }
      </section>
    }
    
  </div>
}

@if (showFinish && finishStats) {
  <div class="backdrop finish">
    <canvas id="confetti-canvas"></canvas> <div class="modal done">
      <h3>¬°Tema completado! üéâ</h3>
      <p>Tiempo: <b>{{ formatTime(finishStats.timeSec) }}</b></p>
      <p>Errores: <b>{{ finishStats.mistakes }}</b></p>
      <p>Precisi√≥n: <b>{{ finishStats.precisionPct }}%</b></p>
      <button class="primary" (click)="goToHome()">Ir a inicio</button>
    </div>
  </div>
}

@if (showExitConfirm) {
  <div class="backdrop">
    <div class="modal">
      <h3>¬øDeseas salir?</h3>
      <p>Tu progreso se guardar√° y podr√°s continuar m√°s tarde.</p>
      <div class="modal-actions">
        <button class="secondary" (click)="showExitConfirm = false">Cancelar</button>
        <button class="primary danger" (click)="exit()">Salir y Guardar</button>
      </div>
    </div>
  </div>
}

<!--@if (showRestartConfirm) {
  <div class="backdrop">
    <div class="modal">
      <h3>Reiniciar Tema</h3>
      <p>Ya completaste este tema. ¬øEst√°s seguro de que quieres **reiniciarlo**? Perder√°s tu progreso actual si exist√≠a.</p>
      <div class="modal-actions">
        <button class="secondary" (click)="showRestartConfirm = false">Cancelar</button>
        <button class="primary danger" (click)="restartTopic()">Reiniciar</button>
      </div>
    </div>
  </div>
}-->